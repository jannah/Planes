<!DOCTYPE html>
<html class="ocks-org do-not-copy">

<head>
    <meta charset="utf-8">
    <title>Sankey Diagram</title>
  <style>

    @import url(http://bost.ocks.org/mike/style.css?aea6f0a);

    #chart {
      height: 300px;
    }

    .node rect {
      cursor: move;
      fill-opacity: .9;
      shape-rendering: crispEdges;
    }

    .node text {
      pointer-events: none;
      text-shadow: 0 1px 0 #fff;
    }

    .link {
      fill: none;
      stroke: #000;
      stroke-opacity: .2;
    }

    .link:hover {
      stroke-opacity: .5;
    }
  </style>
</head>

<select name="select1" id="select1">
    <option value="select">-- select an option --</option>
    <option value="Decade">Decade</option>
    <option value="Make">Make</option>
</select>
<select name="select2" id="select2">
    <option value="select">-- select an option --</option>
</select>
<select name="select3" id="select3">
    <option value="select">-- select an option --</option>
</select>
<input type="submit" id="submit">
</input>

<body>
  <h1> Sankey Diagram - Air Crash </h1>
  <p id = "chart"> 
  </p>

<script src="http://d3js.org/d3.v2.min.js?2.9.1"></script>
<script src="./_js/sankey.js"></script>

<script>

var margin = {top: 1, right: 1, bottom: 6, left: 1},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),
    format = function(d) { return formatNumber(d) + " fatalities"; },
    color = d3.scale.category20();

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var sankey = d3.sankey()
    .nodeWidth(15)
    .nodePadding(10)
    .size([width, height]);

var path = sankey.link();

// Drop down boxes option values  
var drop_down = {
  Decade:['Month', 'Country','Phase'],
  Make:['Country', 'Phase'],
  Month:['Country','Phase'],
  Country: ['Nature','Phase','Airplane Damage'],
  Phase: ['Airplane Damage']
  };

var country = ['Nature', 'Phase', 'Airplane Damage'];
var phase = ['Airplane Damage'];

var multi_dd =   
{
  Decade:{'Month':['Country', 'Phase'], 'Country':country, 'Phase':phase},
  Make:{'Country':country, 'Phase':phase},
  Month:{'Country':country,'Phase':phase},
  Country: {'Nature':[],'Phase':phase,'Airplane Damage':[]},
  Phase: phase
  };

console.log(multi_dd);
var select1 = document.getElementById("select1");
var select2 = document.getElementById("select2");
var select3 = document.getElementById("select3");

var dropdown1 = "test"
var dropdown2 = "test"
var dropdown3 = "test"

//Drop Down Boxes Code - Once you select a value for Dropdown1, a specific list gets populated in Dropdown2

select1.onchange = function() {
// Dropdown Box2 change depending on Dropdown Box1 
    // empty select2
    while (select2.firstChild) {
        select2.removeChild(select2.firstChild);
    }
    //empty select3
    while (select3.firstChild) {
      select3.removeChild(select3.firstChild);
    }

    // Append the initial to "Select an option" node
    // Lesson: Important because it threw off my indexes
    var o = document.createElement("option");
        o.value = "select";
        o.text = ">-- select an option --<";
        select2.appendChild(o);

    if (select1.value == "select") {
        return;
    }

    else {
      dropdown_list = Object.keys(multi_dd[select1.value]);
      console.log(dropdown_list);
      for (var i = 0; i < dropdown_list.length; i++) {
        var o = document.createElement("option");
        o.value = dropdown_list[i];
        o.text = dropdown_list[i];
        select2.appendChild(o);
      }
    }

    // else if (select1.value == "Decade") {
    //   //dropdown_list = drop_down['Decade'];
    //   //console.log(multi_dd);
    //   dropdown_list = Object.keys(multi_dd["Decade"]);
    //   console.log(dropdown_list);
    //   for (var i = 0; i < dropdown_list.length; i++) {
    //     var o = document.createElement("option");
    //     o.value = dropdown_list[i];
    //     o.text = dropdown_list[i];
    //     select2.appendChild(o);
    //   }
    // }
    // else if (select1.value == "Make") {
    //   dropdown_list = drop_down['Make'];
    // for (var i = 0; i < dropdown_list.length; i++) {
    //   var o = document.createElement("option");
    //   o.value = i;
    //   o.text = dropdown_list[i];
    //   select2.appendChild(o);
    //   }
    // }
  }

select2.onchange = function() {
// Dropdown Box3 change depending on Dropdown Box2
    //empty select3     
    while (select3.firstChild) {
      select3.removeChild(select3.firstChild);
    }

    // Append the initial to "Select an option" node
    // Lesson: Important because it threw off my indexes
    var o = document.createElement("option");
        o.value = 0;
        o.text = ">-- select an option --<";
        select3.appendChild(o);
    
    if (select2.value == "select") {
        return;
    }

    else {
      dropdown_list = multi_dd[select1.value][select2.value];
      console.log(dropdown_list);
      for (var i = 0; i < dropdown_list.length; i++) {
        var o = document.createElement("option");
        o.value = dropdown_list[i];
        o.text = dropdown_list[i];
        select3.appendChild(o);
      }
    }


    //Manual intervention that totally made more sense!!!! 
    // else if (select2.selectedIndex == 1) {
    //   dropdown_list = drop_down['Country'];

    // for (var i = 0; i < dropdown_list.length; i++) {
    //   var o = document.createElement("option");
    //   o.value = i;
    //   o.text = dropdown_list[i];
    //   select3.appendChild(o);
    //   }
    // }

    // else if (select2.selectedIndex == 2) {
    //   dropdown_list = drop_down['Country'];
    // for (var i = 0; i < dropdown_list.length; i++) {
    //   var o = document.createElement("option");
    //   o.value = dropdown_list[i];
    //   o.text = dropdown_list[i];
    //   select3.appendChild(o);
    //   }
    // }
}


//Read in the CSV file 
d3.csv("_data/test_python.csv", function(data) {

//Create the data sets and render the diagram upon clicking the Submit button   
submit.onclick = function() {
  //This function gathers the options chosen from the dropdown boxes to then render the data and graph 
  dropdown1 = select1.value.toLowerCase();
  dropdown2 = select2.value.toLowerCase();
  dropdown3 = select3.value.toLowerCase();

  //set up graph in same style as original example but empty
  planes = {"nodes" : [], "links" : []};
    
    data.forEach(function (d) {
      // console.log("check to see if dropdown1 gets in here")
      planes.nodes.push({ "name": d[dropdown1]});
      planes.nodes.push({ "name": d[dropdown2]});
      planes.nodes.push({ "name": d[dropdown3]});
      planes.links.push({ "source": d[dropdown1],
                         "target": d[dropdown2],
                         "value": +d.fatalities});
      planes.links.push({ "source": d[dropdown2],
                        "target": d[dropdown3],
                        "value": +d.fatalities});
     });

  //console.log(planes.nodes);

     // return only the distinct / unique nodes
     planes.nodes = d3.keys(d3.nest()
       .key(function (d) { return d.name; })
       .map(planes.nodes));

     // loop through each link replacing the text with its index from node
     planes.links.forEach(function (d, i) {
       planes.links[i].source = planes.nodes.indexOf(planes.links[i].source);
       planes.links[i].target = planes.nodes.indexOf(planes.links[i].target);
     });

     //now loop through each nodes to make nodes an array of objects
     // rather than an array of strings
     planes.nodes.forEach(function (d, i) {
       planes.nodes[i] = { "name": d };
     });

///Drawing the Sankey Diagram  
  sankey
      .nodes(planes.nodes)
      .links(planes.links)
      .layout(32);

  var link = svg.append("g").selectAll(".link")
      .data(planes.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .sort(function(a, b) { return b.dy - a.dy; });

  link.append("title")
      .text(function(d) { return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value); });

  var node = svg.append("g").selectAll(".node")
      .data(planes.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { this.parentNode.appendChild(this); })
      .on("drag", dragmove));

  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
    .append("title")
      .text(function(d) { return d.name + "\n" + format(d.value); });

  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");

  function dragmove(d) {
    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
    sankey.relayout();
    link.attr("d", path);
  }
}
});

</script>


</body>
</html>